{"componentChunkName":"component---src-templates-post-js","path":"/continuous-integration-pipeline-docker/","result":{"data":{"markdownRemark":{"html":"<p>I built my first websites in the late '90s, and it was pretty simple to get them up and running. You had a single shared server running Apache and you could FTP in by typing <code class=\"language-text\">ftp://ftp.example.com</code> into the URL bar, entering your username and password, and moving your files to the host. They were different times, simpler times.</p>\n<p>Things have changed quite a bit over the past two decades. Websites became more complex and required build steps before going to production. One server became many servers running behind load balancers, and version control and git became commonplace.</p>\n<p>For a personal project, I had a custom setup, and I knew I wanted the ability to deploy my website to production with a single action: merging code into the <code class=\"language-text\">master</code> branch on GitHub. I also knew I didn't want to orchestrate a huge Kubernetes cluster or Docker swarm or server fleet with pods and agents and all sorts of complications for my small web application. In order to do this, I had to get familiar with <strong>CI/CD</strong>.</p>\n<p>So if you have a small project (in this case, Node.js project) and you would like to get an idea of how to automate your deployment so that what's on Git is up to date with what's in production, this article might be of interest to you.</p>\n<h4 id=\"prerequisites\" style=\"position:relative;\"><a href=\"#prerequisites\" aria-label=\"prerequisites permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Prerequisites</h4>\n<ul>\n<li>Basic <a href=\"https://www.taniarascia.com/how-to-use-the-command-line-for-apple-macos-and-linux/\">command line</a> and <a href=\"https://www.taniarascia.com/how-to-create-and-use-bash-scripts/\">bash scripting</a> knowledge</li>\n<li>It will end up using a <a href=\"https://travis-ci.org/\">Travis CI</a> account and a <a href=\"https://hub.docker.com/\">Docker Hub</a> account</li>\n</ul>\n<h4 id=\"goals\" style=\"position:relative;\"><a href=\"#goals\" aria-label=\"goals permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Goals</h4>\n<p>This is not quite a tutorial, just documentation of what I learned and the process I decided upon to test and deploy my code to production in a single automated step.</p>\n<p>My process ended up looking like this:</p>\n<p><strong>Code pushed to all branches and pull requests:</strong></p>\n<ul>\n<li>Kick off a build on <a href=\"https://travis-ci.org/\">Travis CI</a></li>\n<li>Run all unit, integration, and end-to-end tests</li>\n</ul>\n<p><strong>Code pushed to <code class=\"language-text\">master</code> branch only:</strong></p>\n<ul>\n<li>All of the above plus...</li>\n<li>Build a Docker image based on the current code, settings, and environment</li>\n<li>Deploy the image to Docker Hub</li>\n<li>Connect to production server</li>\n<li>Pull the image from Docker Hub</li>\n<li>Stop the current container and start a container based on the new image</li>\n</ul>\n<p>If nothing about Docker, images, and containers makes sense to you yet, don't worry. It'll be covered in the article.</p>\n<h2 id=\"what-is-cicd\" style=\"position:relative;\"><a href=\"#what-is-cicd\" aria-label=\"what is cicd permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What is CI/CD?</h2>\n<p><strong>CI/CD</strong> stands for <strong>continous integration/continuous deployment</strong>.</p>\n<h3 id=\"continous-integration\" style=\"position:relative;\"><a href=\"#continous-integration\" aria-label=\"continous integration permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Continous integration</h3>\n<p><strong>Continuous integration</strong> is the process wherein developers frequently commit to the main source (usually <code class=\"language-text\">master</code> branch) and ensure quality control through automated tests.</p>\n<h3 id=\"continous-deploymentdelivery\" style=\"position:relative;\"><a href=\"#continous-deploymentdelivery\" aria-label=\"continous deploymentdelivery permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Continous deployment/delivery</h3>\n<p><strong>Continuous deployment</strong> is the process of deploying that code frequently through an automated process. You will also see this as <strong>continuous delivery</strong>, which is similar but requires a manual approval before the deployment process runs.</p>\n<h2 id=\"getting-started\" style=\"position:relative;\"><a href=\"#getting-started\" aria-label=\"getting started permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Getting Started</h2>\n<p>The application I used for learning this process was <a href=\"https://github.com/taniarascia/takenote\">TakeNote</a>, a web-based note-taking app I'm working on. Initially, I tried to make a <a href=\"https://jamstack.org/\">JAMStack</a> app, or front-end only without a server, in order to take advantage of the built-in hosting and deployment that <a href=\"https://www.netlify.com/\">Netlify</a> has to offer. As the app grew in complexity, I needed to bring in a server, and therefore would have to figure out my own automated integration and deployment strategy.</p>\n<p>In my case, the app is a <strong>Node.js</strong> and <strong>Express</strong> server, that serves a <strong>React</strong> single page application front end with secure APIs on the back end. This follows the strategy found in the <a href=\"https://www.taniarascia.com/full-stack-cookies-localstorage-react-express/\">Full Stack Authentication</a> tutorial.</p>\n<p>I consulted my friend and automated expert, <a href=\"http://qualitytesting.tech/\">Joe</a>, about what I should do to get this working like I wanted. He gave me the idea for the flow I laid out in the <a href=\"#goals\">goals</a> of this article, which meant I was going to have to figure out how to use Docker.</p>\n<h2 id=\"docker\" style=\"position:relative;\"><a href=\"#docker\" aria-label=\"docker permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Docker</h2>\n<p><strong>Docker</strong> is a tool that allows you to easily share, deploy, and run applications consistently in many environments through containers. First, I needed to get access to the Docker command line (CLI). The <a href=\"https://docs.docker.com/install/\">installation instructions</a> for Docker are not very clear or straightforward, but you need to download <strong>Docker Desktop</strong> (for Mac or Windows).</p>\n<p>Additionally, <strong>Docker Hub</strong> is similar to <a href=\"https://github.com/\">GitHub</a> for git repositories or the <a href=\"https://www.npmjs.com/\">npmjs registry</a> for JavaScript packages - it's an online repository of Docker images and the login that Docker Desktop will connect to.</p>\n<ul>\n<li>Install <a href=\"https://www.docker.com/get-started\">Docker Desktop</a></li>\n<li>Create a <a href=\"https://hub.docker.com/\">Docker Hub</a> account</li>\n</ul>\n<p>Once all this is complete, you can ensure Docker CLI is set up and working by checking the version.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">docker -v</code></pre></div>\n<p>And log in to Docker Hub, where it will prompt you for your username and password.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">docker login</code></pre></div>\n<p>In order to use Docker, you must understand the concept of <strong>images</strong> and <strong>containers</strong>.</p>\n<h3 id=\"images\" style=\"position:relative;\"><a href=\"#images\" aria-label=\"images permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Images</h3>\n<p>An <strong>image</strong> is a blueprint that contains the instructions to build a container. It's an immutable snapshot of the file system and configuration of an application. Images can be easily shared between developers.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># List all images</span>\ndocker images</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"terminal\"><pre class=\"language-terminal\"><code class=\"language-terminal\">REPOSITORY     TAG     IMAGE ID     CREATED     SIZE\n---</code></pre></div>\n<h3 id=\"containers\" style=\"position:relative;\"><a href=\"#containers\" aria-label=\"containers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Containers</h3>\n<p>A <strong>container</strong> is a executable package that contains everything needed to run an application. It will always run the same, regardless of infrastructure, in a sandboxed environment. It is a running instance of an image.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># List all containers</span>\ndocker <span class=\"token function\">ps</span> -a</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"terminal\"><pre class=\"language-terminal\"><code class=\"language-terminal\">CONTAINER ID     IMAGE     COMMAND     CREATED     STATUS     PORTS     NAMES\n---</code></pre></div>\n<h3 id=\"tags\" style=\"position:relative;\"><a href=\"#tags\" aria-label=\"tags permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tags</h3>\n<p>A <strong>tag</strong> is a reference to a specific image version.</p>\n<h3 id=\"cli-reference\" style=\"position:relative;\"><a href=\"#cli-reference\" aria-label=\"cli reference permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>CLI reference</h3>\n<p>Here's an overview a few commonly used commands.</p>\n<table>\n<thead>\n<tr>\n<th>Command</th>\n<th>Context</th>\n<th>Action</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><a href=\"https://docs.docker.com/engine/reference/commandline/build/\"><code class=\"language-text\">docker build</code></a></td>\n<td>Image</td>\n<td>Builds an image from a Dockerfile</td>\n</tr>\n<tr>\n<td><a href=\"https://docs.docker.com/engine/reference/commandline/tag/\"><code class=\"language-text\">docker tag</code></a></td>\n<td>Image</td>\n<td>Tags an image</td>\n</tr>\n<tr>\n<td><a href=\"https://docs.docker.com/engine/reference/commandline/images/\"><code class=\"language-text\">docker images</code></a></td>\n<td>Image</td>\n<td>Lists images</td>\n</tr>\n<tr>\n<td><a href=\"https://docs.docker.com/engine/reference/run/\"><code class=\"language-text\">docker run</code></a></td>\n<td>Container</td>\n<td>Runs a container based on an image</td>\n</tr>\n<tr>\n<td><a href=\"https://docs.docker.com/engine/reference/commandline/push/\"><code class=\"language-text\">docker push</code></a></td>\n<td>Image</td>\n<td>Pushes an image to a registry</td>\n</tr>\n<tr>\n<td><a href=\"https://docs.docker.com/engine/reference/commandline/pull/\"><code class=\"language-text\">docker pull</code></a></td>\n<td>Image</td>\n<td>Pulls an image from a repository</td>\n</tr>\n<tr>\n<td><a href=\"https://docs.docker.com/engine/reference/commandline/ps/\"><code class=\"language-text\">docker ps</code></a></td>\n<td>Container</td>\n<td>Lists containers</td>\n</tr>\n<tr>\n<td><a href=\"https://docs.docker.com/engine/reference/commandline/system_prune/\"><code class=\"language-text\">docker system prune</code></a></td>\n<td>Image/Container</td>\n<td>Remove unused containers and images</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"dockerfile\" style=\"position:relative;\"><a href=\"#dockerfile\" aria-label=\"dockerfile permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Dockerfile</h3>\n<p>I know how to run my app locally for production. I have a Webpack configuration that builds the production React application, then a command to start the Node server on port <code class=\"language-text\">5000</code>. It looks like this.</p>\n<blockquote>\n<p>I don't have a sample application for this article, but any simple Node application should be easy to set up with the following instructions.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> i         <span class=\"token comment\"># install dependencies</span>\n<span class=\"token function\">npm</span> run build <span class=\"token comment\"># build React app</span>\n<span class=\"token function\">npm</span> run start <span class=\"token comment\"># start Node server</span></code></pre></div>\n<p>To use a container, you'll need to give instructions to Docker via a file called <code class=\"language-text\">Dockerfile</code> in the root of your project. <code class=\"language-text\">Dockerfile</code> seems a little intimidating at first, but it's not that much different from how I set up my local environment. It just requires a few <code class=\"language-text\">Dockerfile</code> specific commands.</p>\n<ul>\n<li><a href=\"https://docs.docker.com/engine/reference/builder/#from\">FROM</a> - Start the Dockerfile and pull from a base image</li>\n<li><a href=\"https://docs.docker.com/engine/reference/builder/#copy\">COPY</a> - Copy files from local source to container target</li>\n<li><a href=\"https://docs.docker.com/engine/reference/builder/#workdir\">WORKDIR</a> - Set working directory for subsequent commands</li>\n<li><a href=\"https://docs.docker.com/engine/reference/builder/#run\">RUN</a> - Run commands</li>\n<li><a href=\"https://docs.docker.com/engine/reference/builder/#expose\">EXPOSE</a> - Set a port</li>\n<li><a href=\"https://docs.docker.com/engine/reference/builder/#entrypoint\">ENTRYPOINT</a> - Set executable command</li>\n</ul>\n<p>It looked a little something like this.</p>\n<div class=\"filename\">Dockerfile</div>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token comment\"># Pull from a base image</span>\n<span class=\"token keyword\">FROM</span> node<span class=\"token punctuation\">:</span>12<span class=\"token punctuation\">-</span>alpine\n\n<span class=\"token comment\"># Copy the files from the current directory to app/</span>\n<span class=\"token keyword\">COPY</span> . app/\n\n<span class=\"token comment\"># Use app/ as the working directory</span>\n<span class=\"token keyword\">WORKDIR</span> app/\n\n<span class=\"token comment\"># Install dependencies (npm ci is similar to npm i, but for automated builds)</span>\n<span class=\"token keyword\">RUN</span> npm ci <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>only<span class=\"token punctuation\">-</span>production\n\n<span class=\"token comment\"># Build production client side React application</span>\n<span class=\"token keyword\">RUN</span> npm run build\n\n<span class=\"token comment\"># Listen on the specified port</span>\n<span class=\"token keyword\">EXPOSE</span> 5000\n\n<span class=\"token comment\"># Set Node server</span>\n<span class=\"token keyword\">ENTRYPOINT</span> npm run start</code></pre></div>\n<blockquote>\n<p>Depending on the base image you choose, you might need to install additional dependencies, as certain base images (such as Node Alpine Linux) are meant to be as small as possible and don't have an extensive array of global programs installed.</p>\n</blockquote>\n<h3 id=\"building-tagging-and-running-a-container\" style=\"position:relative;\"><a href=\"#building-tagging-and-running-a-container\" aria-label=\"building tagging and running a container permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Building, tagging, and running a container</h3>\n<p>Building and running a container locally is pretty simple from here. Before attempting to deploy it to Docker Hub for use in automation, you'll want to see if it works locally.</p>\n<h3 id=\"build\" style=\"position:relative;\"><a href=\"#build\" aria-label=\"build permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Build</h3>\n<p>First, you <a href=\"https://docs.docker.com/engine/reference/commandline/build/\">build</a> the image, with a name, and optionally a tag (if no tag is specified, it will be tagged <code class=\"language-text\">latest</code>).</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># Build an image</span>\ndocker build -t <span class=\"token operator\">&lt;</span>image<span class=\"token operator\">></span>:<span class=\"token operator\">&lt;</span>tag<span class=\"token operator\">></span> <span class=\"token builtin class-name\">.</span></code></pre></div>\n<p>You'll see it start running through all the steps.</p>\n<div class=\"gatsby-highlight\" data-language=\"terminal\"><pre class=\"language-terminal\"><code class=\"language-terminal\">Sending build context to Docker daemon   2.88MB\nStep 1/9 : FROM node:12-alpine\n ---&gt; ...running through all the steps...\nSuccessfully built 123456789123\nSuccessfully tagged &lt;image&gt;:&lt;tag&gt;</code></pre></div>\n<p>It might take a minute or two depending on how many dependencies you have. Once it's complete, you can do <code class=\"language-text\">docker images</code> to see your new image.</p>\n<div class=\"gatsby-highlight\" data-language=\"terminal\"><pre class=\"language-terminal\"><code class=\"language-terminal\">REPOSITORY          TAG               IMAGE ID            CREATED              SIZE\n&lt;image&gt;             latest            123456789123        About a minute ago   x.xxGB</code></pre></div>\n<h3 id=\"run\" style=\"position:relative;\"><a href=\"#run\" aria-label=\"run permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Run</h3>\n<p>The image is created, so you can <a href=\"https://docs.docker.com/engine/reference/run/\">run</a> a container based on it. Since I want to view it on <code class=\"language-text\">localhost:5000</code>, I'll set the left side of the port to <code class=\"language-text\">5000</code>, and the right side is which point the container is pointing at.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># Run on local port 5000 and container port 5000</span>\ndocker run -p <span class=\"token number\">5000</span>:5000 <span class=\"token operator\">&lt;</span>image<span class=\"token operator\">></span>:<span class=\"token operator\">&lt;</span>tag<span class=\"token operator\">></span></code></pre></div>\n<p>Now that the container is created and running, you can <code class=\"language-text\">docker ps</code> to see it (or <code class=\"language-text\">docker ps -a</code> to see all containers, if it's not currently running).</p>\n<div class=\"gatsby-highlight\" data-language=\"terminal\"><pre class=\"language-terminal\"><code class=\"language-terminal\">CONTAINER ID        IMAGE               COMMAND                  CREATED              STATUS                      PORTS                    NAMES\n987654321234        &lt;image&gt;             &quot;/bin/sh -c &#39;npm run…&quot;   6 seconds ago        Up 6 seconds                0.0.0.0:5000-&gt;5000/tcp   stoic_darwin</code></pre></div>\n<p>Going to <code class=\"language-text\">localhost:5000</code> will now display your fully built application, just as it will appear in production.</p>\n<h3 id=\"tag-and-publish\" style=\"position:relative;\"><a href=\"#tag-and-publish\" aria-label=\"tag and publish permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tag and publish</h3>\n<p>To use one of these images on a production server, you'll want to be able to retrieve it from Docker Hub. You'll have to create a repository for the project on Docker Hub. Once you do that, you'll have a place to send your image. You'll have to update the image name to be your Docker Hub username and repository, plus whatever tag you want.</p>\n<p>Now you can build and tag like before with the new names, and <code class=\"language-text\">docker push</code> to the Docker Hub repository.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">docker build -t <span class=\"token operator\">&lt;</span>username<span class=\"token operator\">></span>/<span class=\"token operator\">&lt;</span>repository<span class=\"token operator\">></span>:<span class=\"token operator\">&lt;</span>tag<span class=\"token operator\">></span> <span class=\"token builtin class-name\">.</span>\ndocker tag <span class=\"token operator\">&lt;</span>username<span class=\"token operator\">></span>/<span class=\"token operator\">&lt;</span>repository<span class=\"token operator\">></span>:<span class=\"token operator\">&lt;</span>tag<span class=\"token operator\">></span> <span class=\"token operator\">&lt;</span>username<span class=\"token operator\">></span>/<span class=\"token operator\">&lt;</span>repository<span class=\"token operator\">></span>:latest\ndocker push <span class=\"token operator\">&lt;</span>username<span class=\"token operator\">></span>/<span class=\"token operator\">&lt;</span>repository<span class=\"token operator\">></span>:<span class=\"token operator\">&lt;</span>tag<span class=\"token operator\">></span>\n\n<span class=\"token comment\"># It might look something like this:</span>\ndocker build -t user/app:v1.0.0 <span class=\"token builtin class-name\">.</span>\ndocker tag user/app:v1.0.0 user/app:latest\ndocker push user/app:v1.0.0</code></pre></div>\n<p>If all went well, your image will now be live on Docker Hub and it will be easy to share.</p>\n<h3 id=\"next-steps\" style=\"position:relative;\"><a href=\"#next-steps\" aria-label=\"next steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Next steps</h3>\n<p>At this point, I can see that my application is running from a docker container locally, and I have that image on Docker Hub, so that's a big portion of the battle. From here, there are two more issues to cover:</p>\n<ul>\n<li>Setting up a continuous integration tool to test and deploy code</li>\n<li>Setting up a production server to receive and serve code</li>\n</ul>\n<p>In my case, I used <a href=\"https://travis-ci.org/\">Travis CI</a> for CI/CD, and <a href=\"https://www.digitalocean.com/\">DigitalOcean</a> for the server.</p>\n<blockquote>\n<p>There are alternatives for the automation tool and server. For example, instead of Travis, you could use <a href=\"https://circleci.com/\">CircleCI</a> or <a href=\"https://github.com/features/actions\">Github Actions</a>. Instead of DigitalOcean, you could use <a href=\"https://aws.amazon.com/\">AWS</a> or <a href=\"https://www.linode.com/\">Linode</a>.</p>\n</blockquote>\n<p>Since I went with Travis as I already had some testing setup, I can briefly go into what it entails to set up a Travis flow.</p>\n<h2 id=\"travis-ci\" style=\"position:relative;\"><a href=\"#travis-ci\" aria-label=\"travis ci permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Travis CI</h2>\n<p><strong>Travis CI</strong> is a tool for testing and shipping code. I don't want to go too much into the specifics of setting up Travis because every use case will be unique, but I'll cover some of the basics in case you decide to use them. The concepts and configuration will be simple whether you're dealing with Travis, CircleCI, Jenkins, or whatever.</p>\n<p>To use Travis CI, go to the <a href=\"https://travis-ci.org/\">website</a>, create an account, and integrate it with your GitHub account. You'll have to find the GitHub repository you're planning on adding automation to and enable it. (I'm using GitHub, but I'm sure it integrates with BitBucket or GitLab or whatever else.)</p>\n<p>Every time you start a build that's connected to Travis, it will spin up a server that runs all the commands you've specified, including deployment on specific branches.</p>\n<h3 id=\"lifecycle\" style=\"position:relative;\"><a href=\"#lifecycle\" aria-label=\"lifecycle permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lifecycle</h3>\n<p>A Travis configuration file, which will live at <code class=\"language-text\">.travis.yml</code> in the root of your project, has a concept of <a href=\"https://docs.travis-ci.com/user/job-lifecycle/\">lifecycle</a>. From earliest to latest, this is what the lifecycle looks like.</p>\n<ul>\n<li><code class=\"language-text\">apt addons</code></li>\n<li><code class=\"language-text\">cache components</code></li>\n<li><code class=\"language-text\">before_install</code></li>\n<li><code class=\"language-text\">install</code></li>\n<li><code class=\"language-text\">before_script</code></li>\n<li><code class=\"language-text\">script</code></li>\n<li><code class=\"language-text\">before_cache</code></li>\n<li><code class=\"language-text\">after_success</code> or <code class=\"language-text\">after_failure</code></li>\n<li><code class=\"language-text\">before_deploy</code></li>\n<li><code class=\"language-text\">deploy</code></li>\n<li><code class=\"language-text\">after_deploy</code></li>\n<li><code class=\"language-text\">after_script</code></li>\n</ul>\n<h3 id=\"testing\" style=\"position:relative;\"><a href=\"#testing\" aria-label=\"testing permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Testing</h3>\n<p>In my Travis configuration file, I'm going to set up the local Travis server. I've chosen a language of Node, a version of 12, and instructed it to install the necessary dependencies to use Docker.</p>\n<p>Everything in this Travis file will run for all pull requests and branches on the GitHub repository, unless otherwise specified. This is useful because it means we can run tests on all incoming code to see if it's ready to merge into master and won't break the build. For this global configuration, I install everything locally, run a Webpack dev server in the background (specific to my flow), and run the tests.</p>\n<blockquote>\n<p>If you want code coverage badges on your repository, <a href=\"https://www.taniarascia.com/display-build-status-and-test-coverage/\">this quick tutorial</a> explains how to use Jest, Travis, and Coveralls to collect and display coverage.</p>\n</blockquote>\n<div class=\"filename\">.travis.yml</div>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token comment\"># Set the language</span>\n<span class=\"token key atrule\">language</span><span class=\"token punctuation\">:</span> node_js\n\n<span class=\"token comment\"># Set the Node version</span>\n<span class=\"token key atrule\">node_js</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token string\">'12'</span>\n\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># Use Docker command line</span>\n  <span class=\"token punctuation\">-</span> docker\n\n<span class=\"token key atrule\">install</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># Install dependencies for tests</span>\n  <span class=\"token punctuation\">-</span> npm ci\n\n<span class=\"token key atrule\">before_script</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># Start server and client for tests</span>\n  <span class=\"token punctuation\">-</span> npm run dev &amp;\n\n<span class=\"token key atrule\">script</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># Run tests</span>\n  <span class=\"token punctuation\">-</span> npm run test</code></pre></div>\n<p>This signifies the end of lifecycle for branches and pull requests only.</p>\n<h3 id=\"deployment\" style=\"position:relative;\"><a href=\"#deployment\" aria-label=\"deployment permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Deployment</h3>\n<p>Assuming that all automated tests passed, you have the optional ability to deploy code to a production server. Since we only want to do that on <code class=\"language-text\">master</code>, you'll specify that in the deploy config. Before you try inlining code here like in the rest of the steps, I'll warn you that you have to have an actual script to call for the deployment.</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">deploy</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># Build Docker container and push to Docker Hub</span>\n  <span class=\"token key atrule\">provider</span><span class=\"token punctuation\">:</span> script\n  <span class=\"token key atrule\">script</span><span class=\"token punctuation\">:</span> bash deploy.sh\n  <span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branch</span><span class=\"token punctuation\">:</span> master</code></pre></div>\n<p>The deployment script will consist of two aspects:</p>\n<ul>\n<li>Building, tagging and pushing the Docker image from the CI tool (Travis)</li>\n<li>Pulling, stopping and starting the Docker container from the server (DigitalOcean, in this case)</li>\n</ul>\n<p>First, we can set up the building, tagging, and pushing step, which is very similar to the way I did it manually above, except it needs a unique tagging strategy and automated logging in. I struggled with figuring out some aspects the deployment script, such as a tagging strategy, logging in using input, and encoding SSH keys, and dealing with SSH inception. Fortunately my boyfriend is amazing with bash, among many other things, and helped me out with the script.</p>\n<p>So, the first part of the script is getting the image on Docker Hub, which is straightforward. The tag naming I used combines the git hash with the git tag, if it exists. This ensures a unique tag and makes it easy to identify the build it's based on. Here, <code class=\"language-text\">DOCKER_USERNAME</code> and <code class=\"language-text\">DOCKER_PASSWORD</code> are custom environment variables, which you can set through the Travis UI. Travis will redact that sensitive data from showing up in the deploy feed.</p>\n<div class=\"filename\">deploy.sh</div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/sh</span>\n<span class=\"token builtin class-name\">set</span> -e <span class=\"token comment\"># Stop script from running if there are any errors</span>\n\n<span class=\"token assign-left variable\">IMAGE</span><span class=\"token operator\">=</span><span class=\"token string\">\"&lt;username>/&lt;repository>\"</span>                             <span class=\"token comment\"># Docker image</span>\n<span class=\"token assign-left variable\">GIT_VERSION</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">git</span> describe --always --abbrev --tags --long<span class=\"token variable\">)</span></span> <span class=\"token comment\"># Git hash and tags</span>\n\n<span class=\"token comment\"># Build and tag image</span>\ndocker build -t <span class=\"token variable\">${IMAGE}</span><span class=\"token builtin class-name\">:</span><span class=\"token variable\">${GIT_VERSION}</span> <span class=\"token builtin class-name\">.</span>\ndocker tag <span class=\"token variable\">${IMAGE}</span><span class=\"token builtin class-name\">:</span><span class=\"token variable\">${GIT_VERSION}</span> <span class=\"token variable\">${IMAGE}</span>:latest\n\n<span class=\"token comment\"># Log in to Docker Hub and push</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">${DOCKER_PASSWORD}</span>\"</span> <span class=\"token operator\">|</span> docker login -u <span class=\"token string\">\"<span class=\"token variable\">${DOCKER_USERNAME}</span>\"</span> --password-stdin\ndocker push <span class=\"token variable\">${IMAGE}</span><span class=\"token builtin class-name\">:</span><span class=\"token variable\">${GIT_VERSION}</span></code></pre></div>\n<p>The second part of the script depends entirely on what host you're using and the strategy they have for connecting. Since I'm using DigitalOcean, this meant using <a href=\"https://github.com/digitalocean/doctl\">doctl</a> CLI commands. For AWS it would be <code class=\"language-text\">aws</code>, and so on.</p>\n<blockquote>\n<p>There wasn't too much initial setup for the server. I set up a Droplet based on a base image. This system does require installing and starting up Docker once manually, however. I used Ubuntu 18.04, so you can just <a href=\"https://phoenixnap.com/kb/how-to-install-docker-on-ubuntu-18-04\">follow this simple guide</a> to getting that step ready if you're using Ubuntu as well.</p>\n</blockquote>\n<p>I won't supply the individual commands for the service because this will vary wildly, but what you'll do once you SSH into the deployment server will resemble this.</p>\n<ul>\n<li>You'll want to find the currently running container and stop it. (You can do this by setting a <code class=\"language-text\">--name</code> on the container, and stopping and removing that container before setting the new one.)</li>\n<li>\n<p>Then you'll want to start up the new container in the background.</p>\n<ul>\n<li>Add <code class=\"language-text\">--restart-unless-stopped</code> to ensure if something happens, Docker will restart the container.</li>\n<li>Add <code class=\"language-text\">-d</code> to run it in the background, allowing you to escape from the script or run other commands.</li>\n</ul>\n</li>\n<li>You'll want to run the server's local port on <code class=\"language-text\">80</code>, so you can go to <code class=\"language-text\">example.com</code> instead of <code class=\"language-text\">example.com:5000</code>.</li>\n<li>Finally, you'll want to prune all old containers and images.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># Stop, run, and clean</span>\ndocker stop current-container\ndocker <span class=\"token function\">rm</span> current-container\ndocker run --name<span class=\"token operator\">=</span>current-container --restart unless-stopped -d -p <span class=\"token number\">80</span>:5000 <span class=\"token variable\">${IMAGE}</span><span class=\"token builtin class-name\">:</span><span class=\"token variable\">${GIT_VERSION}</span>\ndocker system prune -a -f</code></pre></div>\n<h3 id=\"a-few-things-to-note\" style=\"position:relative;\"><a href=\"#a-few-things-to-note\" aria-label=\"a few things to note permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>A few things to note</h3>\n<p>You might get a warning when connecting to an SSH host from Travis, which will prevent the installation from continuing since it expects input.</p>\n<div class=\"gatsby-highlight\" data-language=\"terminal\"><pre class=\"language-terminal\"><code class=\"language-terminal\">The authenticity of host &#39;&lt;hostname&gt; (&lt;IP address&gt;)&#39; can&#39;t be established.\nRSA key fingerprint is &lt;key fingerprint&gt;.\nAre you sure you want to continue connecting (yes/no)?</code></pre></div>\n<p>I learned (from Vanya) that you can base64 encode a string to store it in a predictable format. In the install phase, you can decode a public key and write it to the <code class=\"language-text\">known_hosts</code> file to bypass that error.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">echo</span> <span class=\"token operator\">&lt;</span>public key<span class=\"token operator\">></span> <span class=\"token operator\">|</span> base64 <span class=\"token comment\"># prints &lt;base 64 encoded public key></span></code></pre></div>\n<p>So in practice, the input would look something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"123.45.67.89 ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAklOUpkDHrfHY17SbrmTIpNLTGK9Tjom/BWDSU\nGPl+nafzlHDTYW7hdI4yZ5ew18JH4JW9jbhUFrviQzM7xlELEVf4h9lFX5QVkbPppSwg0cda3\nPbv7kOdJ/MTyBlWXFCR+HAo3FXRitBqxiX1nKhXpHAZsMciLq8V6RjsNAQwdsdMFvSlVK/7XA\nt3FaoJoAsncM1Q9x5+3V0Ww68/eIFmb1zuUFljQJKprrX88XypNDvjYNby6vw/Pb0rwert/En\nmZ+AW4OZPnTPI89ZPmVMLuayrD2cE86Z/il8b+gw3r3+1nKatmIkjn2so1d01QraTlMqVSsbx\nNrRFi9wrf+M7Q== you@example.com\"</span> <span class=\"token operator\">|</span> base64</code></pre></div>\n<p>And the base64 encoded output:</p>\n<div class=\"gatsby-highlight\" data-language=\"terminal\"><pre class=\"language-terminal\"><code class=\"language-terminal\">MTIzLjQ1LjY3Ljg5IHNzaC1yc2EgQUFBQUIzTnphQzF5YzJFQUFBQUJJd0FBQVFFQWtsT1Vwa0RIcmZIWTE3U2JybVRJcE5MVEdLOVRqb20vQldEU1UKR1BsK25hZnpsSERUWVc3aGRJNHlaNWV3MThKSDRKVzlqYmhVRnJ2aVF6TTd4bEVMRVZmNGg5bEZYNVFWa2JQcHBTd2cwY2RhMwpQYnY3a09kSi9NVHlCbFdYRkNSK0hBbzNGWFJpdEJxeGlYMW5LaFhwSEFac01jaUxxOFY2UmpzTkFRd2RzZE1GdlNsVksvN1hBCnQzRmFvSm9Bc25jTTFROXg1KzNWMFd3NjgvZUlGbWIxenVVRmxqUUpLcHJyWDg4WHlwTkR2allOYnk2dncvUGIwcndlcnQvRW4KbVorQVc0T1pQblRQSTg5WlBtVk1MdWF5ckQyY0U4NlovaWw4YitndzNyMysxbkthdG1Ja2puMnNvMWQwMVFyYVRsTXFWU3NieApOclJGaTl3cmYrTTdRPT0geW91QGV4YW1wbGUuY29tCg==</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">install</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> echo &lt;base 64 encoded public key<span class=\"token punctuation\">></span> <span class=\"token punctuation\">|</span> base64 <span class=\"token punctuation\">-</span>d <span class=\"token punctuation\">></span><span class=\"token punctuation\">></span> $HOME/.ssh/known_hosts</code></pre></div>\n<p>The same tactic can be used with the private key during the connection phase, as you'll likely need a private key to access your server. You'll just want to make sure the private key is securely stored in the Travis environment variable and absolutely not visible from the deployment feed.</p>\n<p>Another thing to note is you might have to run your whole deployment script from a single line, like with <code class=\"language-text\">doctl</code>, which can require some fine-tuning.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">doctl compute <span class=\"token function\">ssh</span> <span class=\"token operator\">&lt;</span>droplet<span class=\"token operator\">></span> --ssh-command <span class=\"token string\">\"all the commands go here &amp;&amp; here\"</span></code></pre></div>\n<h3 id=\"tlsssl-and-load-balancing\" style=\"position:relative;\"><a href=\"#tlsssl-and-load-balancing\" aria-label=\"tlsssl and load balancing permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>TLS/SSL and load balancing</h3>\n<p>Once I finished all this, my only final issue was that the server had no SSL. Since I'm running a Node server, there is a <a href=\"https://www.digitalocean.com/community/tutorials/how-to-secure-a-containerized-node-js-application-with-nginx-let-s-encrypt-and-docker-compose\">massive amount of setup</a> to get an Nginx reverse-proxy and Let's Encrypt up and running.</p>\n<p>I really was not interested in doing all that manual SSL setup, so I simply created a load balancer, and pointed the DNS at the load balancer. With DigitalOcean, for example, creating an auto-renewing self-signed certificate on a load balancer is simple, free, and instant, and has the added benefit of allowing you to easily have SSL set up on multiple servers running behind a load balancer, should you choose to. This also allows the server itself to have no concept of SSL at all, and still run everything on port <code class=\"language-text\">80</code>. Certainly much easier then the alternative, with other added benefits.</p>\n<p>Once that is set up, you can close of all inbound access on all ports for your server except port <code class=\"language-text\">80</code> from the load balancer and <code class=\"language-text\">22</code> for SSH, so trying to hit the server directly by any means except those two will be rejected.</p>\n<h2 id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p>After setting all this up, I'm no longer intimidated by Docker, or the concept of automation pipelines and CI/CD. I managed to set up a full continuous pipeline that tests my code before integrating it with production, and automatically deploys the code to a server. I'm still relatively new to this and I'm sure there are ways to make my process better and more efficient, so if you have any improvements or critiques, <a href=\"mailto:hello@taniarascia.com\">feel free to let me know</a> and I'll update the article accordingly. I hope this article helps you out and you learn as much as I did!</p>","timeToRead":19,"excerpt":"I built my first websites in the late '90s, and it was pretty simple to get them up and running. You had a single shared server running…","frontmatter":{"title":"Building a Continuous Integration & Deployment Pipeline Using Docker (CI/CD)","thumbnail":{"childImageSharp":{"fixed":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAAEjElEQVQ4y52Ua0xbZRjH37YIhbWwjjHupVwKpWAZOKYJLGpiYrx9UBMXY0yMl3lhcSAXuZVeD72XLhtOI8RdPswYuWxc5Fba055z2tICw20QyRx+4JOJxkUNs6x9fHuAZSSoiyd5c573Pc/5n9/zf5/zIvQPl8LmezDmllt9cXILw4nNyywM+l9XtYNBRZbVXWulDyP2XN8ieuebm2z86sUl9MqFJc6zXy6gl88vcZ7vW0DVpwOvH3EEdFU9/rxYTlVPgPNQROqpH/dcLzRQ10su/QpiwvtCbJ5HeHn/KvTm5evI4rrNxqeGV4R4iD749mZS3eCy6KOBZYHMQGqKu8nZIsKtiOVICZLLemn1cfBg38P+opqzwS3B2t4gB0/iY/FjjsBEZU/gF4Xdb8bJd0otvislJuZCkZG5U2iga7eI6fgCA30fSL7tK64AoSc/C+3yQ26mZmVG6nepwWsvIDwbEr1nPFdHjuSYQpCudtU8mPvEmTmx3rnGll9goLgZGs/Wg6fOhaRYWHWsN3T8qMPXWO3w9VXZmTcOW+l+hYVuKjNTn5SavBdlJvpFmZlpkxrp4wCA0tTkaqbG03//C4/3bt0P9/hfqxn8ExQ2/w251Tev6FsDqYm5JPtiDfK76e/FBHVNcu4nyNR6+rI/X4eDKnIxWelKE3a47gpVNIj13pOVdp+EFbNT60nHzvifrrJRo3hoKiyUrszkGSg3eU/ijRiUdpNEgd6tF2tdVyQ694lMlXMoS+XsLDLSCiz4R2K7CxLbZiFJSQG/deZyzIf1o6cDa0cc/uXKHv9qhc23Wm5lVuRm5laJiV7B5a1if1YlhHclV++9la31rGRqyB8w5c+C9tloTCy+yw/c5mlADWN1qMLuu6s4vQDljnkotYeg2BqEIksQ8k0BEBvnIMfgh0zCD4f0fjioZUCkYSBZTYOgk4SkdjcktM5sPNI4bor7eEjOloyJggosJrf4NrHhEUwUwY0ckXRTEexNJFvnjeDdixxSk5FUlTsiUrojyZ2ue4J211+JmiAkNE807uwJr8XJRY9aaKKi9waUmplwsYmBIgMdze+movhvgBy9F7K0HtwuZBSXGD3Q5YYUpSuCvQvv080Dv2XyfEwoQRXgxdWPsM2Oyg2ufLmZ3pBZ5wDThTFdFNPFdi6arfNEMV0U00W36cLJXR4QaOcgsWXyqx2yhIarbC/HN45vnyAG91uynnmQ2kK4Tah7eQQVxnSbmG4zXeMJp8XosH/7iRAI22Z+29f83Yc7YvxtsYTG0a2FEmuQRZXqnC8VEuRKvskPEts1yLUsQpZ5AdKNC5CqIkHUMXM7uXXSIKgfyI7lC83LHH79MCvGbxpD/FMD27/a21qEy2VFxe/a4/JUU8/kqp0NWaoZIkM5rUrrmHrvwKdjtSnv9yfuUAlap3kJdV+zcRIm4zcM7j5tTpTGIdzA3P863lI6XTxh0whLJVI6kaDx6h5nnXoCibsm2bhANYHy1NO8XK2bl00wvAytl5emnOGlto5z9zePIGHzGJK0DaOU5lGU3DC050f/Bu0AI8LFSI2PAAAAAElFTkSuQmCC","width":150,"height":150,"src":"/my-blog/static/4c5ed89490f07b7be7f4e6d496060f5f/4148e/docker.png","srcSet":"/my-blog/static/4c5ed89490f07b7be7f4e6d496060f5f/4148e/docker.png 1x,\n/my-blog/static/4c5ed89490f07b7be7f4e6d496060f5f/de03e/docker.png 1.5x,\n/my-blog/static/4c5ed89490f07b7be7f4e6d496060f5f/1e9e2/docker.png 2x"}}},"slug":"continuous-integration-pipeline-docker","date":"2020-02-07T00:00:00.000Z","categories":["Tools"],"tags":["docker","travis","cicd","automation"],"template":"post"},"fields":{"slug":"/continuous-integration-pipeline-docker/","date":"2020-02-07T00:00:00.000Z"}}},"pageContext":{"slug":"/continuous-integration-pipeline-docker/"}}}